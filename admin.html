<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Administration - La Croix Glorieuse</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { color-scheme: light; }
        body { color: #0f172a; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="pin-overlay" class="fixed inset-0 z-[200] bg-slate-900 flex items-center justify-center p-6">
        <div class="card w-full max-w-sm text-center">
            <h2 class="text-sm font-800 mb-6 text-slate-800 uppercase tracking-widest">AccÃ¨s Restreint</h2>
            <input type="password" id="pin-input" placeholder="Code PIN" 
                class="w-full bg-white p-4 rounded-xl border-none text-center text-2xl font-black tracking-[0.5em] outline-none mb-4 text-slate-900 shadow-inner">
            <button onclick="checkPin()" class="w-full gradient-header text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg">DÃ©verrouiller</button>
        </div>
    </div>

    <header class="gradient-header p-8 rounded-b-[40px] shadow-lg text-white mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-800 tracking-tight mb-1">Espace Admin</h1>
                <p class="text-[10px] font-black uppercase tracking-widest opacity-80">Gestion Paroisse</p>
            </div>
            <a href="index.html" class="bg-white/20 p-3 rounded-2xl">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </a>
        </div>
    </header>

    <main class="p-6 space-y-8 pb-24">

        <section>
            <div class="flex items-center gap-2 mb-4">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Messages ReÃ§us</span>
                <div class="h-[1px] flex-1 bg-slate-200"></div>
            </div>
            <div id="admin-list-messages" class="space-y-4"></div>
        </section>

        <section class="card border-t-4 border-emerald-600">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Entraide Paroissiale</h2>
            <div id="admin-list-entraide" class="space-y-4"></div>
        </section>

        <section class="card border-t-4 border-red-700">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Annonces Accueil</h2>
            <div class="space-y-3 mb-4">
                <input type="text" id="ann-titre" placeholder="Titre" class="w-full bg-slate-50 p-3 rounded-xl border-none text-xs font-bold">
                <textarea id="ann-texte" placeholder="Contenu..." rows="3" class="w-full bg-slate-50 p-3 rounded-xl border-none text-xs"></textarea>
                <button onclick="publierAnnonce()" class="w-full bg-red-700 text-white py-3 rounded-xl font-black text-[10px] uppercase">Publier</button>
            </div>
            <div id="admin-list-annonces" class="space-y-2 pt-4 border-t border-slate-100"></div>
        </section>

        <section class="card border-t-4 border-green-500">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Groupes WhatsApp</h2>
            <div class="space-y-2 mb-4">
                <input type="text" id="group-nom" placeholder="Nom" class="w-full bg-slate-50 p-3 rounded-xl border-none text-xs font-bold">
                <input type="text" id="group-lien" placeholder="Lien" class="w-full bg-slate-50 p-3 rounded-xl border-none text-xs">
                <button onclick="ajouterGroupe()" class="w-full bg-green-600 text-white py-3 rounded-xl font-black text-[10px] uppercase">Ajouter</button>
            </div>
            <div id="admin-list-groupes" class="space-y-2"></div>
        </section>

        <section class="card border-t-4 border-slate-400">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">SÃ©curitÃ© & PIN</h2>
            <div class="flex gap-2">
                <input type="password" id="new-pin-input" placeholder="Nouveau PIN" class="flex-1 bg-slate-50 p-3 rounded-xl border-none text-xs font-bold">
                <button onclick="updatePin()" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase">Changer</button>
            </div>
        </section>

    </main>

    <script src="js/config.js"></script>
    <script>
        function getStoredPin() { return localStorage.getItem('admin_pin') || "1905"; }
        function checkPin() {
            if(document.getElementById('pin-input').value === getStoredPin()) {
                document.getElementById('pin-overlay').style.display = 'none';
                refreshData();
            } else { alert("PIN incorrect"); }
        }
        function updatePin() {
            const np = document.getElementById('new-pin-input').value;
            if(np.length >= 4) { localStorage.setItem('admin_pin', np); alert("PIN mis Ã  jour"); }
        }

        // --- MESSAGES ---
        async function loadMessages() {
            const { data } = await sb.from('contact_messages').select('*').eq('lu', false).order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-messages');
            if (data) {
                list.innerHTML = data.length === 0 ? '<p class="text-[10px] text-slate-400">Aucun message.</p>' : data.map(m => `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[9px] font-black text-slate-400 uppercase">${new Date(m.created_at).toLocaleDateString()}</span>
                            <button onclick="marquerMessageLu('${m.id}')" class="text-emerald-600 text-[9px] font-black">ARCHIVER</button>
                        </div>
                        <p class="text-xs font-800 text-slate-800">${m.prenom} ${m.nom}</p>
                        <div class="bg-red-50 p-2 rounded-lg my-2 border border-red-100 text-[11px] font-bold text-slate-700">
                             ðŸ“§ ${m.email} <br> ðŸ“ž ${m.telephone || 'Non renseignÃ©'}
                        </div>
                        <p class="text-xs text-slate-600 leading-relaxed">"${m.message}"</p>
                    </div>
                `).join('');
            }
        }
        async function marquerMessageLu(id) { await sb.from('contact_messages').update({ lu: true }).eq('id', id); loadMessages(); }

        // --- ENTRAIDE (AFFICHAGE ET GÃ‰NÃ‰RATION DE CODE) ---
        async function loadAdminEntraide() {
            const { data } = await sb.from('entraide').select('*').eq('est_terminee', false).order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-entraide');
            if (data) {
                list.innerHTML = data.length === 0 ? '<p class="text-[10px] text-slate-400">Aucune annonce.</p>' : data.map(e => `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <span class="px-2 py-0.5 rounded text-[8px] font-black uppercase ${e.valide ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                ${e.valide ? 'En ligne' : 'Ã€ Valider'}
                            </span>
                            <div class="flex gap-2">
                                ${!e.valide ? `<button onclick="validerEntraide('${e.id}')" class="text-emerald-600 text-[9px] font-black">VALIDER</button>` : ''}
                                <button onclick="supprimerEntraide('${e.id}')" class="text-red-500 text-[9px] font-black">SUPPRIMER</button>
                            </div>
                        </div>
                        <p class="text-xs font-800 text-slate-800">${e.titre}</p>
                        <div class="bg-slate-50 p-3 rounded-xl border border-dashed border-slate-200 mt-2 flex justify-between items-center">
                            <div>
                                <p class="text-[8px] font-black text-slate-400 uppercase">Demandeur</p>
                                <p class="text-xs font-bold text-slate-700">${e.contact_nom}</p>
                                <p class="text-[10px] text-slate-500">${e.contact_info}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[8px] font-black text-red-400 uppercase">Code de sÃ©curitÃ©</p>
                                ${e.code_validation 
                                    ? `<p class="text-sm font-black text-red-600 tracking-widest">${e.code_validation}</p>`
                                    : `<button onclick="genererCode('${e.id}')" class="bg-red-600 text-white px-2 py-1 rounded text-[8px] font-black">CRÃ‰ER UN CODE</button>`
                                }
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function genererCode(id) {
            const nouveauCode = Math.floor(1000 + Math.random() * 9000).toString();
            await sb.from('entraide').update({ code_validation: nouveauCode }).eq('id', id);
            loadAdminEntraide();
        }

        async function validerEntraide(id) { await sb.from('entraide').update({ valide: true }).eq('id', id); loadAdminEntraide(); }
        async function supprimerEntraide(id) { if(confirm("Supprimer ?")) { await sb.from('entraide').delete().eq('id', id); loadAdminEntraide(); } }

        // --- ANNONCES ACCUEIL ---
        async function loadAdminAnnonces() {
            const { data } = await sb.from('annonces').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-annonces');
            if (data) {
                list.innerHTML = data.map(a => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-lg mb-1"><span class="text-[10px] font-bold truncate">${a.titre}</span><button onclick="supprimerAnnonce('${a.id}')" class="text-red-500 text-[10px] font-black">X</button></div>`).join('');
            }
        }
        async function publierAnnonce() {
            const t = document.getElementById('ann-titre').value;
            const c = document.getElementById('ann-texte').value;
            if(!t || !c) return;
            await sb.from('annonces').insert([{ titre:t, contenu:c }]);
            document.getElementById('ann-titre').value = '';
            document.getElementById('ann-texte').value = '';
            loadAdminAnnonces();
        }
        async function supprimerAnnonce(id) { await sb.from('annonces').delete().eq('id', id); loadAdminAnnonces(); }

        // --- GROUPES ---
        async function loadAdminGroupes() {
            const { data } = await sb.from('groupes').select('*').order('nom');
            const list = document.getElementById('admin-list-groupes');
            if (data) {
                list.innerHTML = data.map(g => `<div class="bg-white p-2 rounded-xl flex justify-between items-center border border-slate-100 mb-1"><span class="text-xs font-bold">${g.nom}</span><button onclick="supprimerGroupe('${g.id}')" class="text-red-500 text-[10px] font-black">X</button></div>`).join('');
            }
        }
        async function ajouterGroupe() {
            const n = document.getElementById('group-nom').value;
            const l = document.getElementById('group-lien').value;
            if(!n) return;
            await sb.from('groupes').insert([{ nom:n, lien_wa:l }]);
            document.getElementById('group-nom').value = '';
            document.getElementById('group-lien').value = '';
            loadAdminGroupes();
        }
        async function supprimerGroupe(id) { await sb.from('groupes').delete().eq('id', id); loadAdminGroupes(); }

        function refreshData() {
            loadMessages();
            loadAdminAnnonces();
            loadAdminEntraide();
            loadAdminGroupes();
        }
    </script>
</body>
</html>
