<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Administration - La Croix Glorieuse</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Force le mode clair pour √©viter les conflits avec le mode sombre du syst√®me */
        :root { color-scheme: light; }
        body { color: #0f172a; } /* Force le texte en slate-900 */
    </style>
</head>
<body class="bg-slate-50">

    <div id="pin-overlay" class="fixed inset-0 z-[200] bg-slate-900 flex items-center justify-center p-6">
        <div class="card w-full max-w-sm text-center">
            <h2 class="text-sm font-800 mb-6 text-slate-800 uppercase tracking-widest">Acc√®s Restreint</h2>
            <input type="password" id="pin-input" placeholder="Entrez le code PIN" 
                class="w-full bg-white p-4 rounded-xl border-none text-center text-2xl font-black tracking-[0.5em] outline-none mb-4 text-slate-900 shadow-inner">
            <button onclick="checkPin()" class="w-full gradient-header text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg">D√©verrouiller</button>
        </div>
    </div>

    <header class="gradient-header p-8 rounded-b-[40px] shadow-lg text-white mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-800 tracking-tight mb-1">Espace Admin</h1>
                <p class="text-[10px] font-black uppercase tracking-widest opacity-80">Gestion Paroisse</p>
            </div>
            <a href="index.html" class="bg-white/20 p-3 rounded-2xl">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </a>
        </div>
    </header>

    <main class="p-6 space-y-8 pb-24">

        <section>
            <div class="flex items-center gap-2 mb-4">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Messages Re√ßus</span>
                <div class="h-[1px] flex-1 bg-slate-200"></div>
            </div>
            <div id="admin-list-messages" class="space-y-4"></div>
        </section>

        <section class="card border-t-4 border-emerald-600">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Entraide Paroissiale</h2>
            <div id="admin-list-entraide" class="space-y-4"></div>
        </section>

        <section class="card border-t-4 border-red-700">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Annonces Accueil</h2>
            <div class="space-y-3 mb-4">
                <input type="text" id="ann-titre" placeholder="Titre de l'annonce" class="w-full bg-slate-50 p-3 rounded-xl border-none text-xs font-bold">
                <textarea id="ann-texte" placeholder="Contenu de l'annonce..." rows="3" class="w-full bg-slate-50 p-3 rounded-xl border-none text-xs"></textarea>
                <div class="flex items-center gap-2 px-1">
                    <input type="checkbox" id="ann-important" class="w-4 h-4 accent-red-600">
                    <label for="ann-important" class="text-[10px] font-black uppercase text-slate-500 tracking-widest">Annonce Importante (Haut de page)</label>
                </div>
                <button onclick="publierAnnonce()" class="w-full bg-red-700 text-white py-3 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-md">Publier l'annonce</button>
            </div>
            <div id="admin-list-annonces" class="space-y-2 pt-4 border-t border-slate-100"></div>
        </section>

        <section class="card border-t-4 border-red-900">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Intentions de Pri√®re</h2>
            <div id="admin-list-pri√®res" class="space-y-3"></div>
        </section>

        <section class="card border-t-4 border-green-500">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Groupes WhatsApp</h2>
            <div class="space-y-2 mb-4">
                <input type="text" id="new-group-name" placeholder="Nom du groupe" class="w-full bg-slate-50 p-3 rounded-xl border-none text-xs font-bold">
                <input type="text" id="new-group-link" placeholder="Lien WhatsApp" class="w-full bg-slate-50 p-3 rounded-xl border-none text-xs">
                <button onclick="ajouterGroupe()" class="w-full bg-green-600 text-white py-3 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-md">Ajouter le groupe</button>
            </div>
            <div id="admin-list-groupes" class="space-y-2"></div>
        </section>

        <section class="card border-t-4 border-slate-400">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">S√©curit√©</h2>
            <div class="flex gap-2">
                <input type="password" id="new-pin-input" placeholder="Nouveau PIN" class="flex-1 bg-slate-50 p-3 rounded-xl border-none text-xs font-bold">
                <button onclick="updatePin()" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-md">Changer</button>
            </div>
        </section>

    </main>

    <script src="js/config.js"></script>
    <script>
        // --- AUTH PIN ---
        function getStoredPin() { return localStorage.getItem('admin_pin') || "1905"; }
        function checkPin() {
            const input = document.getElementById('pin-input').value;
            if (input === getStoredPin()) {
                document.getElementById('pin-overlay').style.display = 'none';
                refreshData();
            } else { alert("PIN incorrect"); }
        }
        function updatePin() {
            const newPin = document.getElementById('new-pin-input').value;
            if (newPin.length >= 4) {
                localStorage.setItem('admin_pin', newPin);
                alert("PIN mis √† jour avec succ√®s !");
            } else { alert("Le PIN doit faire au moins 4 chiffres"); }
        }

        // --- MESSAGES ---
        async function loadMessages() {
            const { data } = await sb.from('contact_messages').select('*').eq('lu', false).order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-messages');
            if (data) {
                list.innerHTML = data.length === 0 ? '<p class="text-[10px] text-slate-400 italic">Aucun nouveau message.</p>' : data.map(m => `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[9px] font-black text-slate-400 uppercase">${new Date(m.created_at).toLocaleDateString()}</span>
                            <button onclick="marquerMessageLu('${m.id}')" class="text-emerald-600 text-[9px] font-black tracking-widest">ARCHIVER</button>
                        </div>
                        <p class="text-xs font-900 text-slate-800 uppercase mb-1">${m.prenom} ${m.nom}</p>
                        <div class="bg-slate-50 p-2 rounded-lg mb-2 border border-slate-100 text-[10px] font-bold text-slate-600">
                             üìß ${m.email} <br> üìû ${m.telephone || 'Non renseign√©'}
                        </div>
                        <p class="text-xs text-slate-600 leading-relaxed italic">"${m.message}"</p>
                    </div>
                `).join('');
            }
        }
        async function marquerMessageLu(id) { await sb.from('contact_messages').update({ lu: true }).eq('id', id); loadMessages(); }

        // --- ENTRAIDE ---
        async function loadAdminEntraide() {
            const { data } = await sb.from('entraide').select('*').eq('est_terminee', false).order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-entraide');
            if (data) {
                list.innerHTML = data.length === 0 ? '<p class="text-[10px] text-slate-400 italic">Aucune annonce.</p>' : data.map(e => `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <span class="px-2 py-0.5 rounded text-[8px] font-black uppercase ${e.valide ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                ${e.valide ? 'Visible' : '√Ä Valider'}
                            </span>
                            <div class="flex gap-2">
                                ${!e.valide ? `<button onclick="validerEntraide('${e.id}')" class="text-emerald-600 text-[9px] font-black uppercase">Valider</button>` : ''}
                                <button onclick="supprimerEntraide('${e.id}')" class="text-red-500 text-[9px] font-black uppercase">Supprimer</button>
                            </div>
                        </div>
                        <p class="text-xs font-800 text-slate-800 mb-1">${e.titre}</p>
                        <div class="bg-slate-50 p-3 rounded-xl border border-dashed border-slate-200 mt-2 flex justify-between items-center">
                            <div>
                                <p class="text-[8px] font-black text-slate-400 uppercase mb-0.5">Demandeur</p>
                                <p class="text-xs font-bold text-slate-700">${e.contact_nom}</p>
                                <p class="text-[10px] text-slate-500">${e.contact_info}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[8px] font-black text-red-400 uppercase mb-0.5">Code de s√©curit√©</p>
                                ${e.code_validation 
                                    ? `<p class="text-sm font-black text-red-600 tracking-widest bg-white px-2 py-1 rounded shadow-sm border border-red-100">${e.code_validation}</p>`
                                    : `<button onclick="genererCode('${e.id}')" class="bg-red-600 text-white px-2 py-1 rounded text-[8px] font-black uppercase">G√©n√©rer Code</button>`
                                }
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        async function genererCode(id) {
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            await sb.from('entraide').update({ code_validation: code }).eq('id', id);
            loadAdminEntraide();
        }
        async function validerEntraide(id) { await sb.from('entraide').update({ valide: true }).eq('id', id); loadAdminEntraide(); }
        async function supprimerEntraide(id) { if(confirm("Supprimer cette annonce ?")) { await sb.from('entraide').delete().eq('id', id); loadAdminEntraide(); } }

        // --- ANNONCES ---
        async function loadAdminAnnonces() {
            const { data } = await sb.from('annonces').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-annonces');
            if (data) {
                list.innerHTML = data.map(a => `
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm mb-1">
                        <div class="truncate mr-4">
                            <span class="text-xs font-800 text-slate-700">${a.titre}</span>
                            ${a.est_importante ? '<span class="ml-2 text-[8px] font-black text-red-600 bg-red-50 px-1.5 py-0.5 rounded border border-red-100 uppercase">‚òÖ Important</span>' : ''}
                        </div>
                        <button onclick="supprimerAnnonce('${a.id}')" class="text-red-500 text-[10px] font-black">X</button>
                    </div>
                `).join('');
            }
        }
        async function publierAnnonce() {
            const titre = document.getElementById('ann-titre').value;
            const contenu = document.getElementById('ann-texte').value;
            const est_importante = document.getElementById('ann-important').checked;
            if(!titre || !contenu) return;
            await sb.from('annonces').insert([{ titre, contenu, est_importante }]);
            document.getElementById('ann-titre').value = '';
            document.getElementById('ann-texte').value = '';
            document.getElementById('ann-important').checked = false;
            loadAdminAnnonces();
        }
        async function supprimerAnnonce(id) { await sb.from('annonces').delete().eq('id', id); loadAdminAnnonces(); }

        // --- PRI√àRES ---
        async function loadAdminPri√®res() {
            const { data } = await sb.from('intentions').select('*').order('valide', { ascending: true }).order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-pri√®res');
            if (data) {
                list.innerHTML = data.length === 0 ? '<p class="text-[10px] text-slate-400 italic">Aucune intention.</p>' : data.map(i => `
                    <div class="bg-white p-4 rounded-2xl border ${i.valide ? 'border-slate-100' : 'border-amber-200 bg-amber-50'} shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[9px] font-black uppercase ${i.valide ? 'text-slate-400' : 'text-amber-600'}">
                                ${i.valide ? 'En ligne' : '√Ä Valider'}
                            </span>
                            <div class="flex gap-2">
                                ${!i.valide ? `<button onclick="validerIntention('${i.id}')" class="text-emerald-600 text-[9px] font-black uppercase tracking-widest">Valider</button>` : ''}
                                <button onclick="supprimerIntention('${i.id}')" class="text-red-500 text-[10px] font-black">X</button>
                            </div>
                        </div>
                        <p class="text-xs font-800 text-slate-800 mb-1">${i.prenom || 'Anonyme'}</p>
                        <p class="text-xs text-slate-600 italic leading-relaxed">"${i.texte}"</p>
                    </div>
                `).join('');
            }
        }
        async function validerIntention(id) {
            await sb.from('intentions').update({ valide: true }).eq('id', id);
            loadAdminPri√®res();
        }
        async function supprimerIntention(id) { if(confirm("Supprimer cette intention ?")) { await sb.from('intentions').delete().eq('id', id); loadAdminPri√®res(); } }

        // --- GROUPES ---
        async function loadAdminGroupes() {
            const { data } = await sb.from('groupes').select('*').order('nom');
            const list = document.getElementById('admin-list-groupes');
            if (data) { list.innerHTML = data.map(g => `<div class="bg-white p-3 rounded-xl flex justify-between items-center border border-slate-100 shadow-sm">
                <span class="text-xs font-800 text-slate-700">${g.nom}</span>
                <button onclick="supprimerGroupe('${g.id}')" class="text-red-500 text-[10px] font-black">X</button>
            </div>`).join(''); }
        }
        async function ajouterGroupe() {
            const nom = document.getElementById('new-group-name').value;
            const lien = document.getElementById('new-group-link').value;
            if(!nom) return;
            await sb.from('groupes').insert([{ nom, lien_wa: lien }]);
            document.getElementById('new-group-name').value = '';
            document.getElementById('new-group-link').value = '';
            loadAdminGroupes();
        }
        async function supprimerGroupe(id) { await sb.from('groupes').delete().eq('id', id); loadAdminGroupes(); }

        function refreshData() {
            loadMessages();
            loadAdminEntraide();
            loadAdminAnnonces();
            loadAdminPri√®res();
            loadAdminGroupes();
        }
    </script>
</body>
</html>
