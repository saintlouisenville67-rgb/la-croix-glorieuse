<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Administration - La Croix Glorieuse</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { color-scheme: light; }
        body { color: #0f172a; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="pin-overlay" class="fixed inset-0 z-[200] bg-slate-900 flex items-center justify-center p-6">
        <div class="card w-full max-w-sm text-center">
            <h2 class="text-sm font-800 mb-6 text-slate-800 uppercase tracking-widest">Accès Restreint</h2>
            <input type="password" id="pin-input" placeholder="Entrez le code PIN" 
                class="w-full bg-white p-4 rounded-xl border-none text-center text-2xl font-black tracking-[0.5em] outline-none mb-4 text-slate-900 shadow-inner">
            <button onclick="checkPin()" class="w-full gradient-header text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg">
                Déverrouiller
            </button>
        </div>
    </div>

    <header class="gradient-header p-8 rounded-b-[40px] shadow-lg text-white mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-800 tracking-tight mb-1">Espace Admin</h1>
                <p class="text-[10px] font-black uppercase tracking-widest opacity-80">Gestion des contenus</p>
            </div>
            <a href="index.html" class="bg-white/20 p-3 rounded-2xl">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </a>
        </div>
    </header>

    <main class="p-6 space-y-8 pb-24">

        <section>
            <div class="flex items-center gap-2 mb-4">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Messages reçus</span>
                <div class="h-[1px] flex-1 bg-slate-200"></div>
            </div>
            <div id="admin-list-messages" class="space-y-4">
                <p class="text-[10px] text-slate-400 italic">Chargement des messages...</p>
            </div>
        </section>

        <section class="card border-t-4 border-red-700">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Publier une annonce</h2>
            <input type="text" id="titre-annonce" placeholder="Titre de l'annonce" class="w-full bg-slate-50 p-4 rounded-xl border-none mb-3 text-sm font-bold text-slate-900">
            <textarea id="texte-annonce" placeholder="Votre message..." rows="3" class="w-full bg-slate-50 p-4 rounded-xl border-none mb-4 text-sm text-slate-700"></textarea>
            
            <div class="flex items-center gap-2 mb-4 px-2">
                <input type="checkbox" id="check-important" class="w-4 h-4 accent-red-600">
                <label for="check-important" class="text-[10px] font-black uppercase text-slate-500 tracking-widest">Annonce importante</label>
            </div>

            <button onclick="publierAnnonce()" class="w-full bg-red-700 text-white py-4 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-md">Publier sur l'accueil</button>
            
            <div id="admin-list-annonces" class="mt-6 space-y-3 border-t pt-6"></div>
        </section>

        <section class="card border-t-4 border-emerald-600">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Entraide Paroissiale</h2>
            <div id="admin-list-entraide" class="space-y-3"></div>
        </section>

        <section class="card border-t-4 border-indigo-600">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Intentions de prière</h2>
            <div id="admin-list-intentions" class="space-y-3"></div>
        </section>

        <section class="card border-t-4 border-green-500">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Groupes WhatsApp</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-group-name" placeholder="Nom" class="flex-1 bg-slate-50 p-3 rounded-xl border-none text-xs font-bold text-slate-900">
                <input type="text" id="new-group-link" placeholder="Lien" class="flex-1 bg-slate-50 p-3 rounded-xl border-none text-xs text-slate-700">
                <button onclick="ajouterGroupe()" class="bg-green-500 text-white px-4 rounded-xl font-black text-xs">+</button>
            </div>
            <div id="admin-list-groupes" class="grid grid-cols-1 gap-2"></div>
        </section>

        <section class="card border-t-4 border-slate-400">
            <h2 class="text-xs font-900 uppercase tracking-widest text-slate-800 mb-4">Sécurité</h2>
            <div class="flex gap-2">
                <input type="password" id="new-pin-input" placeholder="Nouveau PIN" class="flex-1 bg-slate-50 p-3 rounded-xl border-none text-xs font-bold text-slate-900">
                <button onclick="updatePin()" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest">Changer le PIN</button>
            </div>
        </section>

    </main>

    <script src="js/config.js"></script>
    <script>
        function getStoredPin() { return localStorage.getItem('admin_pin') || "1905"; }

        function checkPin() {
            const pin = document.getElementById('pin-input').value;
            if(pin === getStoredPin()) {
                document.getElementById('pin-overlay').style.display = 'none';
                refreshData();
            } else { alert("Code PIN incorrect"); }
        }

        function updatePin() {
            const newPin = document.getElementById('new-pin-input').value;
            if(newPin.length >= 4) {
                localStorage.setItem('admin_pin', newPin);
                alert("Code PIN mis à jour !");
                document.getElementById('new-pin-input').value = '';
            } else { alert("Minimum 4 chiffres."); }
        }

        // --- MESSAGES ---
        async function loadMessages() {
            const { data } = await sb.from('messages').select('*').eq('lu', false).order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-messages');
            if (data) {
                list.innerHTML = data.length === 0 ? '<p class="text-[10px] text-slate-400 italic">Aucun nouveau message.</p>' : data.map(m => `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[9px] font-black text-slate-400 uppercase">${new Date(m.created_at).toLocaleDateString()}</span>
                            <button onclick="marquerMessageLu('${m.id}')" class="text-emerald-600 text-[9px] font-black uppercase">Marquer Lu</button>
                        </div>
                        <p class="text-xs font-800 text-slate-800 mb-1">${m.nom || 'Anonyme'}</p>
                        <p class="text-xs text-slate-600">${m.message}</p>
                    </div>
                `).join('');
            }
        }
        async function marquerMessageLu(id) { await sb.from('messages').update({ lu: true }).eq('id', id); loadMessages(); }

        // --- ANNONCES ---
        async function loadAdminAnnonces() {
            const { data } = await sb.from('annonces').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-annonces');
            if (data) {
                list.innerHTML = data.map(a => `
                    <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl mb-2">
                        <div class="flex-1"><p class="text-[10px] font-black uppercase truncate">${a.titre}</p>
                        ${a.est_importante ? '<span class="text-[8px] font-black text-red-600 uppercase">★ Importante</span>' : ''}</div>
                        <button onclick="supprimerAnnonce('${a.id}')" class="text-red-500 text-[10px] font-black">SUPPR</button>
                    </div>
                `).join('');
            }
        }
        async function publierAnnonce() {
            const titre = document.getElementById('titre-annonce').value;
            const contenu = document.getElementById('texte-annonce').value;
            const estImportante = document.getElementById('check-important').checked;
            if(!titre || !contenu) return;
            await sb.from('annonces').insert([{ titre, contenu, est_importante: estImportante }]);
            document.getElementById('titre-annonce').value = '';
            document.getElementById('texte-annonce').value = '';
            document.getElementById('check-important').checked = false;
            loadAdminAnnonces();
        }
        async function supprimerAnnonce(id) { await sb.from('annonces').delete().eq('id', id); loadAdminAnnonces(); }

        // --- ENTRAIDE ---
        async function loadAdminEntraide() {
            const { data } = await sb.from('entraide').select('*').eq('valide', false).order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-entraide');
            if (data) {
                list.innerHTML = data.length === 0 ? '<p class="text-[10px] text-slate-400 italic">Aucune demande en attente.</p>' : data.map(e => `
                    <div class="bg-white p-3 rounded-xl flex flex-col border border-slate-100 mb-2">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-black uppercase text-emerald-600">${e.type}</span>
                            <div class="flex gap-3">
                                <button onclick="validerEntraide('${e.id}')" class="text-emerald-600 text-[10px] font-black">VALIDER</button>
                                <button onclick="supprimerEntraide('${e.id}')" class="text-red-500 text-[10px] font-black">REFUSER</button>
                            </div>
                        </div>
                        <span class="text-xs text-slate-700 font-bold">${e.titre}</span>
                        <p class="text-[10px] text-slate-500 mt-1">${e.description}</p>
                    </div>
                `).join('');
            }
        }
        async function validerEntraide(id) { await sb.from('entraide').update({ valide: true }).eq('id', id); loadAdminEntraide(); }
        async function supprimerEntraide(id) { await sb.from('entraide').delete().eq('id', id); loadAdminEntraide(); }

        // --- INTENTIONS ---
        async function loadAdminPrières() {
            const { data } = await sb.from('intentions').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('admin-list-intentions');
            if (data) { list.innerHTML = data.map(i => `<div class="bg-white p-3 rounded-xl flex justify-between items-center border border-slate-100 mb-2"><span class="text-xs text-slate-700">${i.prenom}: ${i.contenu}</span><button onclick="supprimerPriere('${i.id}')" class="text-red-500 text-[10px] font-black">X</button></div>`).join(''); }
        }
        async function supprimerPriere(id) { await sb.from('intentions').delete().eq('id', id); loadAdminPrières(); }

        // --- GROUPES ---
        async function loadAdminGroupes() {
            const { data } = await sb.from('groupes').select('*').order('nom');
            const list = document.getElementById('admin-list-groupes');
            if (data) { list.innerHTML = data.map(g => `<div class="bg-white p-3 rounded-xl flex justify-between items-center border border-slate-100 shadow-sm mb-2"><span class="text-xs font-800 text-slate-700">${g.nom}</span><button onclick="supprimerGroupe('${g.id}')" class="text-red-500 text-[10px] font-black">X</button></div>`).join(''); }
        }
        async function ajouterGroupe() {
            const nom = document.getElementById('new-group-name').value;
            const lien = document.getElementById('new-group-link').value;
            if(!nom) return;
            await sb.from('groupes').insert([{ nom, lien_wa: lien }]);
            document.getElementById('new-group-name').value = '';
            document.getElementById('new-group-link').value = '';
            loadAdminGroupes();
        }
        async function supprimerGroupe(id) { await sb.from('groupes').delete().eq('id', id); loadAdminGroupes(); }

        function refreshData() {
            loadMessages();
            loadAdminEntraide();
            loadAdminAnnonces();
            loadAdminPrières();
            loadAdminGroupes();
        }
    </script>
</body>
</html>
