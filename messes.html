<script>
const _supabase = supabase.createClient('https://rixdjcjlepadtchctxnn.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpeGRqY2psZXBhZHRjaGN0eG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTQ2MzMsImV4cCI6MjA4MzE5MDYzM30.0rcj8iFYw-kK7RbAAJ7ZbYqCTdHIWV1DmIQtKP_Ky4c');

let activeDate = new Date();

// 1. CALCUL DE PÃ‚QUES
function getEaster(y) {
    const a = y % 19, b = Math.floor(y / 100), c = y % 100,
          d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25),
          g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30,
          i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7,
          m = Math.floor((a + 11 * h + 22 * l) / 451);
    return new Date(y, Math.floor((h + l - 7 * m + 114) / 31) - 1, ((h + l - 7 * m + 114) % 31) + 1);
}

// 2. TRADUCTEUR DE CODES (TEMPORAL)
function getTemporalCode(date) {
    const y = date.getFullYear();
    const d = new Date(date); d.setHours(0,0,0,0);
    const easter = getEaster(y); easter.setHours(0,0,0,0);
    const diffEaster = Math.round((d - easter) / 86400000);
    
    // Semaine Sainte et Octave de PÃ¢ques (Codes fixes)
    const special = {
        "-7": "rameaux", "-3": "jeudi_saint", "-2": "vendredi_saint", "-1": "samedi_saint",
        "0": "paques_0", "1": "paques_lun", "2": "paques_mar", "3": "paques_mer",
        "4": "paques_jeu", "5": "paques_ven", "6": "paques_sam", "-46": "cendres"
    };
    if (special[diffEaster]) return special[diffEaster];

    // Temps aprÃ¨s la PentecÃ´te (Dimanches)
    if (diffEaster >= 56 && date.getDay() === 0) {
        const week = Math.floor((diffEaster - 49) / 7);
        return `pentecote_${week}`;
    }

    // Temps aprÃ¨s l'Ã‰piphanie (Dimanches)
    if (date.getMonth() === 0 || (date.getMonth() === 1 && diffEaster < -50)) {
        if (date.getDay() === 0) {
            const jan6 = new Date(y, 0, 6);
            const week = Math.ceil((Math.round((d - jan6) / 86400000) + 1) / 7);
            if (week > 0) return `epiphanie_${week}`;
        }
    }

    // Avent (Dimanches)
    const dec25 = new Date(y, 11, 25);
    const sundayBeforeNoel = new Date(dec25);
    sundayBeforeNoel.setDate(dec25.getDate() - (dec25.getDay() || 7));
    const diffNoel = Math.round((d - sundayBeforeNoel) / 86400000);
    if (diffNoel <= 0 && diffNoel > -28 && date.getDay() === 0) {
        const week = 4 + Math.floor(diffNoel / 7);
        return `avent_${week}`;
    }

    return null;
}

// 3. MISE Ã€ JOUR UI ET RÃ‰CUPÃ‰RATION
async function updateLiturgie() {
    const mmdd = `${String(activeDate.getMonth()+1).padStart(2,'0')}-${String(activeDate.getDate()).padStart(2,'0')}`;
    const tCode = getTemporalCode(activeDate);
    
    // On vide les anciens textes
    document.getElementById('text-epitre').innerHTML = "";
    document.getElementById('text-evangile').innerHTML = "";

    // 1. Chercher dans Temporal
    let day = null;
    if (tCode) {
        const { data } = await _supabase.from('temporal').select('*').eq('code_temporel', tCode).maybeSingle();
        day = data;
    }

    // 2. Si non trouvÃ©, chercher dans Sanctoral
    if (!day) {
        const { data } = await _supabase.from('sanctoral').select('*').eq('date_id', mmdd).maybeSingle();
        day = data;
    }

    const final = day || { fete: "FÃ©rie", classe: "IV", epitre_ref: "---", evangile_ref: "---" };

    document.getElementById('display-date').innerText = activeDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
    document.getElementById('display-feast').innerText = final.nom_jour || final.fete;
    document.getElementById('display-rank').innerText = "Classe " + final.classe;
    document.getElementById('display-rank').className = `rank-tag cl-${final.classe}`;
    document.getElementById('ref-epitre').innerText = final.epitre_ref || "---";
    document.getElementById('ref-evangile').innerText = final.evangile_ref || "---";
    document.getElementById('readings-panel').style.display = 'none';
}

// 4. DÃ‰COUPEUR DE RÃ‰FÃ‰RENCE (PARSER)
function parseRef(ref) {
    if (!ref || ref === "---") return null;
    // Nettoyage des guillemets Ã©ventuels et espaces
    const cleanRef = ref.replace(/"/g, '').trim();
    const m = cleanRef.match(/^(.+)\s(\d+),\s(\d+)(?:-(\d+))?$/);
    if (!m) return null;
    return {
        book: m[1].trim(),
        chap: parseInt(m[2]),
        start: parseInt(m[3]),
        end: m[4] ? parseInt(m[4]) : parseInt(m[3])
    };
}

// 5. CHARGEMENT DU TEXTE BIBLE
async function loadBible(type) {
    const refText = document.getElementById('ref-' + type).innerText;
    const p = parseRef(refText);
    const container = document.getElementById('text-' + type);
    
    if (!p) { container.innerHTML = "Pas de lecture propre aujourd'hui."; return; }
    
    container.innerHTML = "Chargement du texte...";
    
    const { data, error } = await _supabase
        .from('bible_crampon')
        .select('texte, verset')
        .eq('livre', p.book)
        .eq('chapitre', p.chap)
        .gte('verset', p.start)
        .lte('verset', p.end)
        .order('verset', { ascending: true });

    if (error || !data || data.length === 0) {
        container.innerHTML = `<span style="color:red">Texte introuvable (${p.book} ${p.chap}, ${p.start}). VÃ©rifiez l'orthographe dans votre base.</span>`;
    } else {
        container.innerHTML = data.map(v => `<span class="verset-num">${v.verset}</span>${v.texte}`).join(' ');
    }
}

function toggleReadings() {
    const panel = document.getElementById('readings-panel');
    const isVisible = panel.style.display === 'block';
    panel.style.display = isVisible ? 'none' : 'block';
    document.getElementById('toggle-btn').innerText = isVisible ? "ðŸ“– VOIR LES LECTURES" : "âœ– FERMER";
    if (!isVisible) {
        loadBible('epitre');
        loadBible('evangile');
    }
}

function changeDate(n) {
    activeDate.setDate(activeDate.getDate() + n);
    updateLiturgie();
}

updateLiturgie();
</script>
