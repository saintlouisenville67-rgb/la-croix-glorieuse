<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missel 1962</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Georgia', serif; background: #fdfaf5; color: #1a1a1a; margin: 0; padding-bottom: 50px; }
        
        /* En-tête simple et lisible */
        header { background: #630a0a; color: white; padding: 25px 15px; text-align: center; border-bottom: 4px solid #c5a059; }
        .nav { display: flex; justify-content: space-between; align-items: center; max-width: 400px; margin: 0 auto; }
        .date-display { font-size: 1.3rem; font-weight: bold; text-transform: uppercase; background: white; color: #630a0a; padding: 5px 15px; border-radius: 10px; }
        .btn-nav { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; }

        .fete-nom { font-size: 1.6rem; margin: 15px 0 5px; font-weight: 800; }
        .classe-badge { display: inline-block; padding: 3px 10px; background: #eee; color: #333; border-radius: 5px; font-size: 0.8rem; font-weight: bold; }

        /* Contenu */
        main { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e0d9cc; }
        .reading-header { color: #8b0000; font-weight: bold; border-bottom: 1px solid #eee; margin-bottom: 10px; padding-bottom: 5px; display: block; }
        .reference { font-size: 1.2rem; font-weight: bold; display: block; margin-bottom: 10px; font-style: italic; }
        .texte-bible { line-height: 1.8; font-size: 1.2rem; text-align: justify; }
        .v-num { font-size: 0.8rem; color: #8b0000; vertical-align: super; margin-right: 4px; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div class="nav">
        <button class="btn-nav" onclick="changerJour(-1)">❮</button>
        <div id="date-text" class="date-display">...</div>
        <button class="btn-nav" onclick="changerJour(1)">❯</button>
    </div>
    <div id="fete-nom" class="fete-nom">Chargement...</div>
    <div id="classe-badge" class="classe-badge">CLASSE --</div>
</header>

<main>
    <div class="card">
        <span class="reading-header">ÉPÎTRE</span>
        <span id="ref-epitre" class="reference">...</span>
        <div id="txt-epitre" class="texte-bible"></div>
    </div>

    <div class="card">
        <span class="reading-header">ÉVANGILE</span>
        <span id="ref-evangile" class="reference">...</span>
        <div id="txt-evangile" class="texte-bible"></div>
    </div>
</main>

<script>
const SB_URL = 'https://rixdjcjlepadtchctxnn.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpeGRqY2psZXBhZHRjaGN0eG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTQ2MzMsImV4cCI6MjA4MzE5MDYzM30.0rcj8iFYw-kK7RbAAJ7ZbYqCTdHIWV1DmIQtKP_Ky4c';
const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

let dateActuelle = new Date();

// Traduction simplifiée des noms pour la Bible Crampon
const livreTraductions = {
    "Matthew": "S. Matthieu", "Mark": "S. Marc", "Luke": "S. Luc", "John": "S. Jean",
    "Sirach": "Siracide", "Isaiah": "Isaïe", "2 Timothy": "2 Timothée", "1 Peter": "1 S. Pierre"
};

async function chargerLiturgie() {
    const moisJour = `${String(dateActuelle.getMonth() + 1).padStart(2, '0')}-${String(dateActuelle.getDate()).padStart(2, '0')}`;
    
    // Affichage de la date
    document.getElementById('date-text').innerText = dateActuelle.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });

    // 1. Chercher dans le Sanctoral (Dates fixes)
    let { data: jour } = await supabaseClient.from('sanctoral').select('*').eq('date_id', moisJour).maybeSingle();

    if (!jour) {
        jour = { fete: "Férie", classe: "IV", epitre_ref: "---", evangile_ref: "---" };
    }

    // Mise à jour de l'interface
    document.getElementById('fete-nom').innerText = jour.fete;
    document.getElementById('classe-badge').innerText = "CLASSE " + jour.classe;
    
    // Affichage des références traduites
    document.getElementById('ref-epitre').innerText = traduireRef(jour.epitre_ref);
    document.getElementById('ref-evangile').innerText = traduireRef(jour.evangile_ref);

    // Chargement des textes
    chargerTexte(jour.epitre_ref, 'txt-epitre');
    chargerTexte(jour.evangile_ref, 'txt-evangile');
}

function traduireRef(ref) {
    if (!ref || ref === "---") return "---";
    let r = ref.replace(/"/g, '');
    for (const [eng, fra] of Object.entries(livreTraductions)) {
        if (r.startsWith(eng)) return r.replace(eng, fra);
    }
    return r;
}

async function chargerTexte(ref, elementId) {
    const conteneur = document.getElementById(elementId);
    if (!ref || ref === "---") { conteneur.innerHTML = "Pas de lecture propre."; return; }

    // On prépare la référence pour la SQL (on enlève les guillemets)
    let refSQL = ref.replace(/"/g, '');
    
    // Analyse de la référence : Livre Chapitre, Début-Fin
    const match = refSQL.match(/^(.+)\s(\d+),\s(\d+)(?:-(\d+))?$/);
    if (!match) return;

    const livre = match[1].trim();
    const chap = parseInt(match[2]);
    const debut = parseInt(match[3]);
    const fin = match[4] ? parseInt(match[4]) : debut;

    const { data: versets } = await supabaseClient.from('bible_crampon')
        .select('texte, verset')
        .eq('livre', livre).eq('chapitre', chap)
        .gte('verset', debut).lte('verset', fin)
        .order('verset');

    if (versets && versets.length > 0) {
        let texteFinal = versets.map(v => `<span class="v-num">${v.verset}</span>${v.texte}`).join(' ');
        // Ajouter un point final si manquant
        if (!texteFinal.trim().endsWith('.') && !texteFinal.trim().endsWith('!') && !texteFinal.trim().endsWith('?')) {
            texteFinal += ".";
        }
        conteneur.innerHTML = texteFinal;
    } else {
        conteneur.innerHTML = "Texte introuvable dans la base.";
    }
}

function changerJour(n) {
    dateActuelle.setDate(dateActuelle.getDate() + n);
    chargerLiturgie();
}

// Lancement au démarrage
document.addEventListener('DOMContentLoaded', chargerLiturgie);
</script>

</body>
</html>
