<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Missel 1962 - Messes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --prie-dieu: #630a0a; --fond: #fdfaf5; --or: #c5a059; }
        body { margin: 0; font-family: 'Segoe UI', serif; background-color: var(--fond); color: #1a1a1a; }
        .header-content { background: var(--prie-dieu); padding: 35px 20px; text-align: center; border-bottom: 5px solid var(--or); color: white; }
        .nav-header { display: flex; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto 20px; }
        .date-badge { background: white; color: var(--prie-dieu); padding: 10px 25px; border-radius: 30px; font-weight: 900; font-size: 1.2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #display-feast { font-size: 1.8rem; font-weight: 800; margin: 15px 0 5px; text-transform: uppercase; line-height: 1.2; }
        .rank-tag { display: inline-block; font-size: 0.85rem; font-weight: 900; padding: 6px 18px; border-radius: 10px; text-transform: uppercase; margin-top: 10px; }
        .cl-I { background: #ffd700; color: #000; } .cl-II { background: #e2e8f0; color: #1e293b; } .cl-III { background: #94a3b8; color: #fff; } .cl-IV { background: none; border: 1px solid white; color: white; }
        .btn-nav { background: none; border: none; color: white; font-size: 2.5rem; cursor: pointer; }
        .main-content { padding: 20px; max-width: 650px; margin: 0 auto; }
        .btn-open-readings { width: 100%; border: 3px solid var(--prie-dieu); padding: 22px; border-radius: 18px; font-weight: 900; font-size: 1.2rem; cursor: pointer; background: white; color: var(--prie-dieu); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .reading-card { margin-top: 25px; display: none; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid #e0d9cc; }
        .reading-title { color: var(--prie-dieu); font-weight: 900; text-transform: uppercase; font-size: 0.9rem; border-bottom: 2px solid #f0ede5; padding-bottom: 8px; margin-bottom: 20px; display: block; }
        .reading-ref { font-family: 'Georgia', serif; font-size: 1.4rem; font-weight: 700; color: #333; margin-bottom: 20px; display: block; font-style: italic; }
        .bible-text { font-family: 'Georgia', serif; line-height: 2; font-size: 1.3rem; color: #222; text-align: justify; }
        .verset-num { font-size: 0.85rem; font-weight: bold; color: var(--prie-dieu); vertical-align: super; margin-right: 8px; }
    </style>
</head>
<body>

    <header class="header-content">
        <div class="nav-header">
            <button class="btn-nav" onclick="changeDate(-1)">‚Äπ</button>
            <div class="date-badge" id="display-date">...</div>
            <button class="btn-nav" onclick="changeDate(1)">‚Ä∫</button>
        </div>
        <div id="display-rank" class="rank-tag"></div>
        <h1 id="display-feast">...</h1>
        <button class="btn-open-readings" id="toggle-btn" onclick="toggleReadings()">üìñ LIRE LA MESSE</button>
    </header>

    <main class="main-content">
        <div id="readings-panel" class="reading-card">
            <div id="section-epitre">
                <span class="reading-title">√âp√Ætre</span>
                <span class="reading-ref" id="ref-epitre"></span>
                <div id="text-epitre" class="bible-text"></div>
            </div>
            <div style="height: 50px;"></div>
            <div id="section-evangile">
                <span class="reading-title">√âvangile</span>
                <span class="reading-ref" id="ref-evangile"></span>
                <div id="text-evangile" class="bible-text"></div>
            </div>
        </div>
    </main>

<script>
const SB_URL = 'https://rixdjcjlepadtchctxnn.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpeGRqY2psZXBhZHRjaGN0eG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTQ2MzMsImV4cCI6MjA4MzE5MDYzM30.0rcj8iFYw-kK7RbAAJ7ZbYqCTdHIWV1DmIQtKP_Ky4c';
let _supabase;
let activeDate = new Date();

const trad = {
    "Genesis":"Gen√®se","Exodus":"Exode","Leviticus":"L√©vitique","Numbers":"Nombres","Deuteronomy":"Deut√©ronome","Joshua":"Josu√©","Judges":"Juges","Ruth":"Ruth","1 Samuel":"1 Samuel","2 Samuel":"2 Samuel","1 Kings":"1 Rois","2 Kings":"2 Rois","1 Chronicles":"1 Chroniques","2 Chronicles":"2 Chroniques","Ezra":"Esdras","Nehemiah":"N√©h√©mie","Tobit":"Tobie","Judith":"Judith","Esther":"Esther","Job":"Job","Psalms":"Psaumes","Proverbs":"Proverbes","Ecclesiastes":"Eccl√©siaste","Song of Solomon":"Cantique","Wisdom":"Sagesse","Sirach":"Siracide","Isaiah":"Isa√Øe","Jeremiah":"J√©r√©mie","Lamentations":"Lamentations","Baruch":"Baruch","Ezekiel":"√âz√©chiel","Daniel":"Daniel","Hosea":"Os√©e","Joel":"Jo√´l","Amos":"Amos","Obadiah":"Abdias","Jonah":"Jonas","Micah":"Mich√©e","Nahum":"Nahum","Habakkuk":"Habacuc","Zephaniah":"Sophonie","Haggai":"Agg√©e","Zechariah":"Zacharie","Malachi":"Malachie","1 Maccabees":"1 Maccab√©es","2 Maccabees":"2 Maccab√©es","Matthew":"S. Matthieu","Mark":"S. Marc","Luke":"S. Luc","John":"S. Jean","Acts":"Actes","Romans":"Romains","1 Corinthians":"1 Corinthiens","2 Corinthians":"2 Corinthiens","Galatians":"Galates","Ephesians":"√âph√©siens","Philippians":"Philippiens","Colossians":"Colossiens","1 Thessalonians":"1 Thessaloniens","2 Thessalonians":"2 Thessaloniens","1 Timothy":"1 Timoth√©e","2 Timothy":"2 Timoth√©e","Titus":"Tite","Philemon":"Phil√©mon","Hebrews":"H√©breux","James":"S. Jacques","1 Peter":"1 S. Pierre","2 Peter":"2 S. Pierre","1 John":"1 S. Jean","2 John":"2 S. Jean","3 John":"3 S. Jean","Jude":"S. Jude","Revelation of John":"Apocalypse"
};

function getEaster(y) {
    const a=y%19, b=Math.floor(y/100), c=y%100, d=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-d-g+15)%30, i=Math.floor(c/4), k=c%7, l=(32+2*e+2*i-h-k)%7, m=Math.floor((a+11*h+22*l)/451);
    return new Date(y, Math.floor((h+l-7*m+114)/31)-1, ((h+l-7*m+114)%31)+1);
}

function getTemporalCode(date) {
    const y=date.getFullYear(), d=new Date(date); d.setHours(0,0,0,0);
    const easter=getEaster(y); easter.setHours(0,0,0,0);
    const diff = Math.round((d - easter) / 86400000);
    const special = {"-7":"rameaux","-3":"jeudi_saint","-2":"vendredi_saint","-1":"samedi_saint","0":"paques_0","1":"paques_lun","2":"paques_mar","3":"paques_mer","4":"paques_jeu","5":"paques_ven","6":"paques_sam","-46":"cendres"};
    if(special[diff]) return special[diff];
    // Pentec√¥te et apr√®s
    if(diff>=49 && diff<56) {
        const pDays = ["paques_0","paques_lun","paques_mar","paques_mer","paques_jeu","paques_ven","paques_sam"]; // Re-mapping
        if(diff === 49) return "pentecote_0";
    }
    if(diff>=56 && date.getDay()===0) return `pentecote_${Math.floor((diff-49)/7)}`;
    return diff.toString();
}

async function updateLiturgie() {
    const mmdd = `${String(activeDate.getMonth()+1).padStart(2,'0')}-${String(activeDate.getDate()).padStart(2,'0')}`;
    const tCode = getTemporalCode(activeDate);
    const [resTemp, resSanc] = await Promise.all([
        _supabase.from('temporal').select('*').eq('code_temporel', tCode).maybeSingle(),
        _supabase.from('sanctoral').select('*').eq('date_id', mmdd).maybeSingle()
    ]);
    let day = resTemp.data || resSanc.data || { fete: "F√©rie", classe: "IV", epitre_ref: "---", evangile_ref: "---" };
    // R√®gle de pr√©s√©ance 1962
    if (resTemp.data && resSanc.data) {
        if (parseInt(resSanc.data.classe) < parseInt(resTemp.data.classe)) day = resSanc.data;
        else day = resTemp.data;
    }
    const fmtRef = (r) => {
        if(!r || r === "---") return "---";
        let clean = r.replace(/"/g, '').trim();
        for (const [eng, fra] of Object.entries(trad)) {
            if (clean.startsWith(eng)) return clean.replace(eng, fra);
        }
        return clean;
    };
    document.getElementById('display-date').innerText = activeDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase();
    document.getElementById('display-feast').innerText = day.nom_jour || day.fete;
    document.getElementById('display-rank').innerText = "CLASSE " + day.classe;
    document.getElementById('display-rank').className = "rank-tag cl-" + day.classe;
    document.getElementById('ref-epitre').innerText = fmtRef(day.epitre_ref);
    document.getElementById('ref-evangile').innerText = fmtRef(day.evangile_ref);
    document.getElementById('readings-panel').style.display = 'none';
}

async function loadText(type) {
    const refAffichee = document.getElementById('ref-' + type).innerText;
    if(refAffichee === "---") return;
    let refSQL = refAffichee;
    for (const [eng, fra] of Object.entries(trad)) {
        if (refAffichee.startsWith(fra)) { refSQL = refAffichee.replace(fra, eng); break; }
    }
    const match = refSQL.match(/^(.+)\s(\d+),\s(\d+)(?:-(\d+))?$/);
    const container = document.getElementById('text-' + type);
    if (!match) return;
    const p = { book: match[1].trim(), chap: parseInt(match[2]), start: parseInt(match[3]), end: match[4] ? parseInt(match[4]) : parseInt(match[3]) };
    container.innerHTML = "<i>Chargement...</i>";
    const { data } = await _supabase.from('bible_crampon').select('texte, verset')
        .eq('livre', p.book).eq('chapitre', p.chap).gte('verset', p.start).lte('verset', p.end).order('verset');

    if (!data || data.length === 0) {
        container.innerHTML = "Texte non trouv√©.";
    } else {
        let fullContent = data.map(v => `<span class="verset-num">${v.verset}</span>${v.texte}`).join(' ');
        let lastChar = data[data.length - 1].texte.trim().slice(-1);
        if (!['.', '!', '?'].includes(lastChar)) fullContent += ".";
        container.innerHTML = fullContent;
    }
}

function toggleReadings() {
    const p = document.getElementById('readings-panel');
    const isVisible = p.style.display === 'block';
    p.style.display = isVisible ? 'none' : 'block';
    document.getElementById('toggle-btn').innerText = isVisible ? "üìñ LIRE LA MESSE" : "‚úñ FERMER";
    if (!isVisible) { loadText('epitre'); loadText('evangile'); }
}

function changeDate(n) { activeDate.setDate(activeDate.getDate() + n); updateLiturgie(); }

document.addEventListener('DOMContentLoaded', () => {
    _supabase = supabase.createClient(SB_URL, SB_KEY);
    updateLiturgie();
});
</script>
</body>
</html>
