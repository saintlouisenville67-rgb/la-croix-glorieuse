<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Missel 1962 - Messes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --prie-dieu: #4a0404; --liturgie-gold: #c5a059; --text-dark: #1a1a1a; }
        body { margin: 0; font-family: -apple-system, sans-serif; background-color: #f4f1ea; color: var(--text-dark); }
        
        /* HEADER VISIBLE */
        .header-content { background: linear-gradient(135deg, #630a0a 0%, #3a0202 100%); padding: 30px 20px; text-align: center; color: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .nav-header { display: flex; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto 15px; }
        .date-badge { background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 25px; font-weight: 700; font-size: 1rem; border: 1px solid rgba(255,255,255,0.3); }
        .btn-nav { background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; padding: 5px 15px; }
        
        #display-feast { font-size: 1.6rem; font-weight: 800; margin: 10px 0; color: #ffffff; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .rank-tag { display: inline-block; font-size: 0.75rem; font-weight: 900; padding: 4px 12px; border-radius: 6px; text-transform: uppercase; margin-bottom: 10px; }
        .cl-I { background: #ffd700; color: #000; } .cl-II { background: #e2e8f0; color: #1e293b; } .cl-III { background: #94a3b8; color: #fff; }
        
        /* LECTURES */
        .main-content { padding: 20px; max-width: 600px; margin: -20px auto 0; }
        .btn-open-readings { width: 100%; border: none; padding: 20px; border-radius: 15px; font-weight: 800; font-size: 1.1rem; cursor: pointer; background: white; color: var(--prie-dieu); box-shadow: 0 8px 16px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .btn-open-readings:active { transform: scale(0.98); }
        
        .reading-card { margin-top: 25px; display: none; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e0d5; }
        .reading-title { color: #8b0000; font-weight: 900; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; border-bottom: 2px solid #f4f1ea; padding-bottom: 5px; margin-bottom: 15px; display: block; }
        .reading-ref { font-family: serif; font-size: 1.2rem; font-weight: 700; color: #2d3748; margin-bottom: 15px; display: block; font-style: italic; }
        .bible-text { font-family: 'Georgia', serif; line-height: 1.85; font-size: 1.2rem; color: #2d3436; text-align: justify; }
        .verset-num { font-size: 0.75rem; font-weight: bold; color: #b91c1c; vertical-align: super; margin-right: 5px; margin-left: 2px; }
    </style>
</head>
<body>

    <header class="header-content">
        <div class="nav-header">
            <button class="btn-nav" onclick="changeDate(-1)">‚ùÆ</button>
            <div class="date-badge" id="display-date">--/--/----</div>
            <button class="btn-nav" onclick="changeDate(1)">‚ùØ</button>
        </div>
        <div id="display-rank" class="rank-tag"></div>
        <h1 id="display-feast">Chargement...</h1>
        <button class="btn-open-readings" id="toggle-btn" onclick="toggleReadings()">üìñ VOIR LES LECTURES</button>
    </header>

    <main class="main-content">
        <div id="readings-panel" class="reading-card">
            <div id="section-epitre">
                <span class="reading-title">√âp√Ætre</span>
                <span class="reading-ref" id="ref-epitre"></span>
                <div id="text-epitre" class="bible-text"></div>
            </div>
            <div id="section-evangile" style="margin-top: 40px;">
                <span class="reading-title">√âvangile</span>
                <span class="reading-ref" id="ref-evangile"></span>
                <div id="text-evangile" class="bible-text"></div>
            </div>
        </div>
    </main>

<script>
const SB_URL = 'https://rixdjcjlepadtchctxnn.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpeGRqY2psZXBhZHRjaGN0eG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTQ2MzMsImV4cCI6MjA4MzE5MDYzM30.0rcj8iFYw-kK7RbAAJ7ZbYqCTdHIWV1DmIQtKP_Ky4c';
let _supabase;
let activeDate = new Date();

const trad = {
    "Genesis":"Gen√®se","Exodus":"Exode","Leviticus":"L√©vitique","Numbers":"Nombres","Deuteronomy":"Deut√©ronome","Joshua":"Josu√©","Judges":"Juges","Ruth":"Ruth","1 Samuel":"1 Samuel","2 Samuel":"2 Samuel","1 Kings":"1 Rois","2 Kings":"2 Rois","1 Chronicles":"1 Chroniques","2 Chronicles":"2 Chroniques","Ezra":"Esdras","Nehemiah":"N√©h√©mie","Tobit":"Tobie","Judith":"Judith","Esther":"Esther","Job":"Job","Psalms":"Psaumes","Proverbs":"Proverbes","Ecclesiastes":"Eccl√©siaste","Song of Solomon":"Cantique","Wisdom":"Sagesse","Sirach":"Siracide","Isaiah":"Isa√Øe","Jeremiah":"J√©r√©mie","Lamentations":"Lamentations","Baruch":"Baruch","Ezekiel":"√âz√©chiel","Daniel":"Daniel","Hosea":"Os√©e","Joel":"Jo√´l","Amos":"Amos","Obadiah":"Abdias","Jonah":"Jonas","Micah":"Mich√©e","Nahum":"Nahum","Habakkuk":"Habacuc","Zephaniah":"Sophonie","Haggai":"Agg√©e","Zechariah":"Zacharie","Malachi":"Malachie","1 Maccabees":"1 Maccab√©es","2 Maccabees":"2 Maccab√©es","Matthew":"Matthieu","Mark":"Marc","Luke":"Luc","John":"Jean","Acts":"Actes","Romans":"Romains","1 Corinthians":"1 Corinthiens","2 Corinthians":"2 Corinthiens","Galatians":"Galates","Ephesians":"√âph√©siens","Philippians":"Philippiens","Colossians":"Colossiens","1 Thessalonians":"1 Thessaloniens","2 Thessalonians":"2 Thessaloniens","1 Timothy":"1 Timoth√©e","2 Timothy":"2 Timoth√©e","Titus":"Tite","Philemon":"Phil√©mon","Hebrews":"H√©breux","James":"Jacques","1 Peter":"1 Pierre","2 Peter":"2 Pierre","1 John":"1 Jean","2 John":"2 Jean","3 John":"3 Jean","Jude":"Jude","Revelation of John":"Apocalypse"
};

function getEaster(y) {
    const a=y%19, b=Math.floor(y/100), c=y%100, d=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-d-g+15)%30, i=Math.floor(c/4), k=c%7, l=(32+2*e+2*i-h-k)%7, m=Math.floor((a+11*h+22*l)/451);
    const month = Math.floor((h+l-7*m+114)/31);
    const day = ((h+l-7*m+114)%31)+1;
    return new Date(y, month-1, day);
}

function getTemporalCode(date) {
    const y=date.getFullYear(), d=new Date(date); d.setHours(0,0,0,0);
    const easter=getEaster(y); easter.setHours(0,0,0,0);
    const diff = Math.round((d - easter) / 86400000);
    const special = {"-7":"rameaux","-3":"jeudi_saint","-2":"vendredi_saint","-1":"samedi_saint","0":"paques_0","1":"paques_lun","2":"paques_mar","3":"paques_mer","4":"paques_jeu","5":"paques_ven","6":"paques_sam","-46":"cendres"};
    if(special[diff]) return special[diff];
    if(diff>=56 && date.getDay()===0) return `pentecote_${Math.floor((diff-49)/7)}`;
    if(date.getMonth()===0 && date.getDay()===0) {
        const j6 = new Date(y,0,6);
        const w = Math.ceil((Math.round((d-j6)/86400000)+1)/7);
        if(w>0) return `epiphanie_${w}`;
    }
    return diff.toString();
}

async function updateLiturgie() {
    const mmdd = `${String(activeDate.getMonth()+1).padStart(2,'0')}-${String(activeDate.getDate()).padStart(2,'0')}`;
    const tCode = getTemporalCode(activeDate);
    
    // Requ√™tes parall√®les pour vitesse
    const [resTemp, resSanc] = await Promise.all([
        _supabase.from('temporal').select('*').eq('code_temporel', tCode).maybeSingle(),
        _supabase.from('sanctoral').select('*').eq('date_id', mmdd).maybeSingle()
    ]);

    let day = resTemp.data || resSanc.data || { fete: "F√©rie", classe: "IV", epitre_ref: "", evangile_ref: "" };
    if (resTemp.data && resSanc.data && (resSanc.data.classe === "I") && resTemp.data.classe !== "I") day = resSanc.data;

    // Traduction Ref
    const fmtRef = (r) => {
        if(!r || r === "---") return "---";
        let clean = r.replace(/"/g, '');
        for (const [eng, fra] of Object.entries(trad)) {
            if (clean.startsWith(eng)) return clean.replace(eng, fra);
        }
        return clean;
    };

    document.getElementById('display-date').innerText = activeDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase();
    document.getElementById('display-feast').innerText = day.nom_jour || day.fete;
    document.getElementById('display-rank').innerText = "CLASSE " + day.classe;
    document.getElementById('display-rank').className = "rank-tag cl-" + day.classe;
    document.getElementById('ref-epitre').innerText = fmtRef(day.epitre_ref);
    document.getElementById('ref-evangile').innerText = fmtRef(day.evangile_ref);
    document.getElementById('readings-panel').style.display = 'none';
    document.getElementById('toggle-btn').innerText = "üìñ VOIR LES LECTURES";
}

async function loadText(type) {
    const refAffich√©e = document.getElementById('ref-' + type).innerText;
    if(refAffich√©e === "---") return;

    // Retrouver le nom anglais pour SQL
    let refSQL = refAffich√©e;
    for (const [eng, fra] of Object.entries(trad)) {
        if (refAffich√©e.startsWith(fra)) {
            refSQL = refAffich√©e.replace(fra, eng);
            break;
        }
    }

    const match = refSQL.match(/^(.+)\s(\d+),\s(\d+)(?:-(\d+))?$/);
    if (!match) return;

    const p = { book: match[1].trim(), chap: parseInt(match[2]), start: parseInt(match[3]), end: match[4] ? parseInt(match[4]) : parseInt(match[3]) };
    const container = document.getElementById('text-' + type);
    container.innerHTML = "<div style='color:#666'>Chargement du texte sacr√©...</div>";

    const { data } = await _supabase.from('bible_crampon').select('texte, verset')
        .eq('livre', p.book).eq('chapitre', p.chap).gte('verset', p.start).lte('verset', p.end).order('verset');

    if (!data || data.length === 0) {
        container.innerHTML = `<span style="color:#b91c1c; font-size:0.9rem;">‚ö†Ô∏è Texte introuvable dans bible_crampon (${p.book} ${p.chap}). V√©rifiez les noms de livres.</span>`;
    } else {
        container.innerHTML = data.map(v => `<span class="verset-num">${v.verset}</span>${v.texte}`).join(' ');
    }
}

function toggleReadings() {
    const panel = document.getElementById('readings-panel');
    const isVisible = panel.style.display === 'block';
    panel.style.display = isVisible ? 'none' : 'block';
    document.getElementById('toggle-btn').innerText = isVisible ? "üìñ VOIR LES LECTURES" : "‚úñ FERMER";
    if (!isVisible) { loadText('epitre'); loadText('evangile'); }
}

function changeDate(n) { activeDate.setDate(activeDate.getDate() + n); updateLiturgie(); }

document.addEventListener('DOMContentLoaded', () => {
    _supabase = supabase.createClient(SB_URL, SB_KEY);
    updateLiturgie();
});
</script>
</body>
</html>
