<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Missel Romain 1962 - Version Intégrale</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --prie-dieu: #630a0a; --or: #c5a059; --creme: #fdfaf5; }
        body { margin: 0; font-family: 'Georgia', serif; background-color: var(--creme); color: #1a1a1a; }
        
        /* HEADER LITURGIQUE */
        .header-content { background: var(--prie-dieu); padding: 30px 20px; text-align: center; border-bottom: 5px solid var(--or); color: white; }
        .nav-header { display: flex; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto 15px; }
        .date-badge { background: white; color: var(--prie-dieu); padding: 8px 20px; border-radius: 20px; font-weight: 900; font-size: 1.1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-nav { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; padding: 0 15px; }
        
        #display-feast { font-size: 1.6rem; font-weight: 800; margin: 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        .rank-tag { display: inline-block; font-size: 0.8rem; font-weight: 900; padding: 5px 15px; border-radius: 5px; text-transform: uppercase; margin-bottom: 5px; }
        .cl-I { background: #ffd700; color: #000; } .cl-II { background: #e2e8f0; color: #1e293b; } .cl-III { background: #94a3b8; color: #fff; }
        
        /* LECTURES */
        .main-content { padding: 20px; max-width: 650px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e0d9cc; margin-bottom: 20px; }
        .reading-title { color: var(--prie-dieu); font-weight: 900; text-transform: uppercase; font-size: 0.85rem; border-bottom: 2px solid #f0ede5; padding-bottom: 5px; margin-bottom: 15px; display: block; }
        .reading-ref { font-size: 1.3rem; font-weight: 700; color: #333; margin-bottom: 15px; display: block; font-style: italic; }
        .bible-text { line-height: 1.9; font-size: 1.25rem; text-align: justify; }
        .verset-num { font-size: 0.8rem; font-weight: bold; color: var(--prie-dieu); vertical-align: super; margin-right: 5px; }
    </style>
</head>
<body>

    <header class="header-content">
        <div class="nav-header">
            <button class="btn-nav" onclick="changeDate(-1)">‹</button>
            <div class="date-badge" id="display-date">...</div>
            <button class="btn-nav" onclick="changeDate(1)">›</button>
        </div>
        <div id="display-rank" class="rank-tag"></div>
        <h1 id="display-feast">...</h1>
    </header>

    <main class="main-content">
        <div id="moteur-status" style="text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 15px;"></div>
        
        <div id="readings-container">
            <div class="card">
                <span class="reading-title">Épître</span>
                <span class="reading-ref" id="ref-epitre">---</span>
                <div id="text-epitre" class="bible-text"></div>
            </div>
            <div class="card">
                <span class="reading-title">Évangile</span>
                <span class="reading-ref" id="ref-evangile">---</span>
                <div id="text-evangile" class="bible-text"></div>
            </div>
        </div>
    </main>

<script>
const SB_URL = 'https://rixdjcjlepadtchctxnn.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpeGRqY2psZXBhZHRjaGN0eG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTQ2MzMsImV4cCI6MjA4MzE5MDYzM30.0rcj8iFYw-kK7RbAAJ7ZbYqCTdHIWV1DmIQtKP_Ky4c';
let _supabase;
let activeDate = new Date();

const trad = { "Genesis":"Genèse","Exodus":"Exode","Leviticus":"Lévitique","Numbers":"Nombres","Deuteronomy":"Deutéronome","Sirach":"Siracide","Isaiah":"Isaïe","Matthew":"S. Matthieu","Mark":"S. Marc","Luke":"S. Luc","John":"S. Jean","Acts":"Actes","Revelation of John":"Apocalypse","2 Timothy":"2 Timothée" };

/** 1. CALCULS DES FÊTES MOBILES **/
function getEaster(y) {
    const a=y%19, b=Math.floor(y/100), c=y%100, d=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-d-g+15)%30, i=Math.floor(c/4), k=c%7, l=(32+2*e+2*i-h-k)%7, m=Math.floor((a+11*h+22*l)/451);
    return new Date(y, Math.floor((h+l-7*m+114)/31)-1, ((h+l-7*m+114)%31)+1);
}

function getAdvent1(y) {
    let d = new Date(y, 10, 30); // St André
    while(d.getDay() !== 0) d.setDate(d.getDate() - 1);
    if(d.getMonth() === 11 && d.getDate() > 3) d.setDate(d.getDate() - 7);
    return d;
}

/** 2. MOTEUR DE PRÉSÉANCE (1962) **/
async function determinerLiturgie(date) {
    const y = date.getFullYear();
    const d = new Date(date); d.setHours(0,0,0,0);
    const mmdd = `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    
    // Calcul codes temporels
    const easter = getEaster(y);
    const adv1 = getAdvent1(y);
    const diffEaster = Math.round((d - easter) / 86400000);
    const diffAdv = Math.round((d - adv1) / 86400000);

    let tCode = null;
    if (diffAdv >= 0 && diffAdv < 28) tCode = `avent_${Math.floor(diffAdv/7)+1}`;
    else if (diffEaster === 0) tCode = "paques_0";
    else if (diffEaster > 0 && diffEaster <= 6) {
        const pMap = ["paques_0","paques_lun","paques_mar","paques_mer","paques_jeu","paques_ven","paques_sam"];
        tCode = pMap[diffEaster];
    }
    else if (diffEaster === 49) tCode = "pentecote_0";
    else if (diffEaster > 49 && d.getDay() === 0) tCode = `pentecote_${Math.floor((diffEaster-49)/7)}`;
    else if (mmdd === "01-01") tCode = "octave_noel"; // Exemple de fixe forcé en temporal

    // Fetch Sanctoral, Temporal, Commun
    const [resTemp, resSanc] = await Promise.all([
        _supabase.from('temporal').select('*').eq('code_temporel', tCode || 'none').maybeSingle(),
        _supabase.from('sanctoral').select('*').eq('date_id', mmdd).maybeSingle()
    ]);

    let final = resTemp.data || resSanc.data || { fete: "Férie", classe: "IV", epitre_ref: "---", evangile_ref: "---" };

    // Règle d'or : Sanctoral I l'emporte sur Temporal II. Temporal I l'emporte sur tout.
    if (resTemp.data && resSanc.data) {
        const cT = parseInt(resTemp.data.classe) || 4;
        const cS = parseInt(resSanc.data.classe) || 4;
        final = (cS < cT) ? resSanc.data : resTemp.data;
    }

    // Gestion du Commun (Si la référence est "commun_...")
    if (final.epitre_ref && final.epitre_ref.startsWith("commun_")) {
        const { data: com } = await _supabase.from('communs').select('*').eq('code_commun', final.epitre_ref).maybeSingle();
        if(com) { final.epitre_ref = com.epitre_ref; final.evangile_ref = com.evangile_ref; }
    }

    return final;
}

/** 3. CHARGEMENT BIBLE CRAMPON **/
async function loadBible(ref, targetId) {
    const container = document.getElementById(targetId);
    if (!ref || ref === "---") { container.innerHTML = ""; return; }

    // Nettoyage et Traduction
    let sqlRef = ref.replace(/"/g, '').trim();
    for (const [eng, fra] of Object.entries(trad)) {
        if (sqlRef.startsWith(fra)) sqlRef = sqlRef.replace(fra, eng);
    }

    const m = sqlRef.match(/^(.+)\s(\d+),\s(\d+)(?:-(\d+))?$/);
    if (!m) return;

    const p = { b: m[1].trim(), c: parseInt(m[2]), s: parseInt(m[3]), e: m[4] ? parseInt(m[4]) : parseInt(m[3]) };
    
    const { data } = await _supabase.from('bible_crampon').select('texte, verset')
        .eq('livre', p.b).eq('chapitre', p.c).gte('verset', p.s).lte('verset', p.e).order('verset');

    if (data && data.length > 0) {
        let txt = data.map(v => `<span class="verset-num">${v.verset}</span>${v.texte}`).join(' ');
        if (!['.','!','?'].includes(txt.trim().slice(-1))) txt += ".";
        container.innerHTML = txt;
    } else {
        container.innerHTML = `<span style="color:red">Verset non trouvé (${p.b} ${p.c}:${p.s})</span>`;
    }
}

/** 4. INTERFACE **/
async function update() {
    document.getElementById('display-date').innerText = activeDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase();
    
    const jour = await determinerLiturgie(activeDate);
    
    document.getElementById('display-feast').innerText = jour.nom_jour || jour.fete;
    document.getElementById('display-rank').innerText = "CLASSE " + jour.classe;
    document.getElementById('display-rank').className = "rank-tag cl-" + jour.classe;
    
    const fmt = (r) => {
        let f = r; for(const [e,fr] of Object.entries(trad)) f = f.replace(e, fr); return f;
    };
    
    document.getElementById('ref-epitre').innerText = fmt(jour.epitre_ref);
    document.getElementById('ref-evangile').innerText = fmt(jour.evangile_ref);
    
    loadBible(jour.epitre_ref, 'text-epitre');
    loadBible(jour.evangile_ref, 'text-evangile');
}

function changeDate(n) { activeDate.setDate(activeDate.getDate() + n); update(); }

document.addEventListener('DOMContentLoaded', () => {
    _supabase = supabase.createClient(SB_URL, SB_KEY);
    update();
});
</script>
</body>
</html>
